# Mark duplicates

In this chapter we start from a BAM file and we mark PCR/optical duplicates. First, using [samtools](https://www.htslib.org/doc/) we need to ensure that the records in the BAM file are sorted by read name. Then we can use [samblaster](https://github.com/GregoryFaust/samblaster) to mark the duplicates and generate a new SAM file. Finally, we can convert the SAM file back to coordinate sorted BAM file using samtools.

## Input data

Data folder: `/project/varcall_training/data/partial/alignment`

Files: `hg38.snps.bam` and `hg19.svs.bam` (or you can use the BAM files generated by the aligner in the previous step)

## Suggested computational resources

To process the small test dataset, we suggest the following computational resources:

- CPUs: 1
- Memory: 8 GB

## Commands

Navigate to your desired output folder and run the following commands. Here we provide example commands using the `hg38.snps.bam` input file. The same commands can be used for the `hg19.svs.bam` file.

### 1. Sort your reads by read name

```bash
singularity exec -B /localscratch -B /project/varcall_training -B $PWD \
	/project/varcall_training/bin/varcall_latest.sif \
	samtools sort -O SAM -n /project/varcall_training/data/partial/alignment/hg38.snps.bam > snps.sam
```

This will run for approximately 3 minutes using a single CPU and will create the `snps.sam` file in the current directory. This file contains the reads sorted by read name.

#### Options explained

| Option | Description |
|--------|-------------|
| `-O` | Set the output format |
| `-n` | Sort by read name |

### 2. Mark duplicates

```bash
singularity exec -B /localscratch -B /project/varcall_training -B $PWD \
	/project/varcall_training/bin/varcall_latest.sif \
	samblaster -i snps.sam -o snps.dedup.sam 2> samblaster.log
```

This will run for approximately 1 minute using a single CPU and will create the `snps.dedup.sam` file in the current directory.
This file contains the reads sorted by read name with duplicate reads marked in alignment flag.

A log file `samblaster.log` will be created in the current directory where you can read some useful stats about duplicates.

#### Options explained

| Option | Description |
|--------|-------------|
| `-i` | Input file |
| `-o` | Output file |

### 3. Convert the SAM file back to a coordinate sorted BAM

This step is necessary since the variant callers need a coordinate sorted BAM file as input.

```bash
singularity exec -B /localscratch -B /project/varcall_training -B $PWD \
	/project/varcall_training/bin/varcall_latest.sif \
	samtools sort --write-index -O BAM -o snps.dedup.bam snps.dedup.sam
```

This will run for approximately 3 minutes using a single CPU and will create the `snps.dedup.bam` and `snps.dedup.bam.bai` files in the current directory. The BAM file contains the reads sorted by coordinates with duplicate reads marked in alignment flag.

### Options explained

| Option | Description |
|--------|-------------|
| `--write-index` | Write the index after sorting |
| `-O` | Set the output format |